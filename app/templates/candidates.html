{% extends 'main.html' %}

{% block content %}
    <title>Candidate Dashboard</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
          integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    
    <!-- Animate.css for simple, ready-to-use animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Đã có Bootstrap, FontAwesome, Animate.css trong main.html, 
         nên không cần load lại (nếu main.html lo việc này) -->

    <style>
        /* ------------------------------
           ANIMATION
        ------------------------------ */
        @keyframes fadeBody {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        @keyframes fadeUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ------------------------------
           CONTENT
        ------------------------------ */
        .content {
            margin-left: 250px;
            padding: 40px;
            transition: all 0.3s ease;
            /* Hoặc dùng animation fadeBody nếu muốn */
            animation: fadeBody 0.4s ease-in-out;
        }

        /* ------------------------------
           TABLE CONTAINER
        ------------------------------ */
        .table-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.05);
            width: calc(94vw - 210px);
            position: relative;
            animation: fadeUp 0.5s ease-in-out;
        }

        /* Table responsive (overflow-x auto) */
        .table-responsive {
            overflow-x: auto;
        }

        /* TABLE ROWS hover hiệu ứng */
        .table tbody tr:hover {
            background-color: #f1f3f5;
            transition: background-color 0.2s ease;
        }

        /* ACTION ICONS hover scale */
        .action-icons i:hover {
            transform: scale(1.1);
            transition: 0.2s;
        }

        .action-icons i {
            display: inline-block !important;
            visibility: visible !important;
        }

        /* ------------------------------
           UPLOAD AREA
        ------------------------------ */
        .upload-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .upload-area:hover {
            background-color: #f0f0f0;
        }

        /* ------------------------------
           MODAL INFO
        ------------------------------ */
        .info-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            min-width: 300px;
            opacity: 0;
            transition: all 0.3s ease;
        }
        .info-modal.show {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .info-modal ul {
            list-style-type: none;
            padding-left: 20px;
        }
        /* Animation when closing */
        .info-modal.hide {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.9);
        }

        /* ------------------------------
           OVERLAY MỜ
        ------------------------------ */
        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Show the overlay with fade-in effect */
        .overlay.show {
            display: block;
            opacity: 1;
        }

        /* Hide overlay smoothly when closing */
        .overlay.hide {
            opacity: 0;
        }

        /* ------------------------------
           PHÂN TRANG 
        ------------------------------ */
        .pagination-container {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #555;
        }
        .pagination {
            display: flex;
            align-items: center;
            margin-left: 15px;
        }
        .pagination button {
            background: none;
            border: none;
            padding: 5px 8px;
            margin: 0 3px;
            border-radius: 4px;
            cursor: pointer;
            color: #007bff;
        }
        .pagination button:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .pagination button:disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #007bff;
            border: none;
            border-radius: 6px;
            transition: transform 0.2s ease, background-color 0.2s;
            position: relative;
            overflow: hidden; /* Để ripple không tràn */
        }
        .btn-primary:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        /* Ripple effect (demo) */
        .btn-primary:active::after {
            content: "";
            position: absolute;
            width: 100px; 
            height: 100px;
            background: rgba(255,255,255,0.4);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            top: var(--y);
            left: var(--x);
            pointer-events: none;
        }
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* ------------------------------
           RESPONSIVE MEDIA QUERIES
        ------------------------------ */
        @media (max-width: 992px) {
          .content {
              margin-left: 0;
              padding: 20px;
          }
          .table-container {
              width: 100% !important;
              margin: 0 auto;
          }
        }

        /* ------------------------------
           SEARCH BAR
        ------------------------------ */
        .search-bar {
            display: inline-flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .search-bar i {
            margin-right: 8px;
            color: #aaa;
        }
        .search-bar input[type="text"] {
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 6px 12px;
            width: 250px;
        }

        /* ------------------------------
              PILL STATUS
        ------------------------------ */
        .pill {
          display: inline-block;
          padding: 4px 10px;
          border-radius: 20px;
          font-size: 0.85rem;
          color: #fff;
          font-weight: 500;
        }
        .pill-Passed {
          background: #198754; /* green */
        }
        .pill-Pending {
          background: #eeea16; /* yellow */
        }
        .pill-Rejected {
          background: #d81111; /* red */
        }
    </style>
</head>

<body>
    <!-- 1) Khu vực “Upload CV” -->
    <div class="d-flex">
      <div class="content">
          <h3 class="mb-4" style="animation: fadeUp 0.5s ease-in-out;">Candidates</h3>

          <div class="table-container">
              <div class="upload-area">
                  <i class="fas fa-file-upload fa-2x mb-2"></i>
                  <p class="mb-2">Drag your files here or click in this area. <br> PDF and DOCX formats are available.</p>
                  <button class="btn btn-primary btn-sm">Upload</button>
                  <button class="btn btn-secondary btn-sm">Clear</button>
              </div>
          </div>
      </div>
    </div>

    <!-- 2) Danh sách Candidates -->
    <div class="d-flex">
      <div class="content">
        <h3 class="mb-4" style="animation: fadeUp 0.5s ease-in-out;">List of Uploaded Candidates</h3>
            <div class="table-container table-responsive">
              <div class="mb-3 d-flex justify-content-between align-items-center">
                  <form method="GET" action="{% url 'candidates' %}" class = "search-bar">
                      <i class = "fas fa-search"></i>
                      <input type = "text" name = "search" placeholder = "Search Job..." value = "{{ search_query }}">
                      <button type = "submit" class = "btn btn-primary">Search</button>
                  </form>
              </div>
              <table class="table" id="candidateTable">
                  <thead>
                      <tr>
                          <th>ID</th>
                          <th>Candidate Name</th>
                          <th>Email Address</th>
                          <th>Phone Number</th>
                          <th>Added Date</th>
                          <th>Results</th>
                          <th>Action</th>
                      </tr>
                  </thead>
                  <tbody>
                    {% for resume in resumes %}
                    <tr data-resume-id="{{ resume.resume_id }}"
                    data-name="{{ resume.resume_name }}"
                    data-email="{{ resume.resume_email }}"
                    data-phone="{{ resume.resume_phone }}"
                    data-path="{{ resume.resume_path }}"
                    data-text="{{ resume.resume_text }}"
                    data-date-added="{{ resume.resume_date_added }}"
                    data-education="{{ resume.resume_education }}"
                    data-experience="{{ resume.resume_experience }}"
                    data-tech-skills="{{ resume.resume_tech_skills }}"
                    data-soft-skills="{{ resume.resume_soft_skills }}"
                    data-certificates="{{ resume.resume_certificates }}"
                    data-status="{{ resume.resume_status }}"
                    data-summary="{{ resume.resume_summary }}">
                        <td>{{ resume.resume_id }}</td>
                        <td class="candidate-name">{{ resume.resume_name }}</td>
                        <td class="candidate-email">{{ resume.resume_email }}</td>
                        <td class="candidate-phone">{{ resume.resume_phone }}</td>
                        <td class="candidate-added-date">{{ resume.resume_date_added }}</td>
                        <td>
                            <span class="pill {% if resume.resume_status == 'Passed' %}pill-Passed 
                                               {% elif resume.resume_status == 'Pending' %}pill-Pending
                                               {% else %}pill-Rejected{% endif %}">
                                {{ resume.resume_status }}
                            </span>
                        </td>
                        <td class="action-icons">
                            <i class="fas fa-edit text-primary edit-btn" title="Edit"></i>
                            <i class="fas fa-trash-alt text-danger" title="Delete" onclick = "confirmDelete({{ resume.resume_id }})"></i>
                            <i class="fas fa-info-circle text-info" title="View Info" 
                                onclick = "showInfo({
                                    name: '{{ resume.resume_name|escapejs }}',
                                    email: '{{ resume.resume_email|escapejs }}',
                                    phone: '{{ resume.resume_phone|escapejs }}',
                                    text: '{{ resume.resume_text|escapejs|linebreaksbr }}',
                                    education: '{{ resume.resume_education|escapejs }}',
                                    experience: '{{ resume.resume_experience|escapejs }}',
                                    skills: '{{ resume.resume_tech_skills|escapejs }}'.split(','),
                                    softSkills: '{{ resume.resume_soft_skills|escapejs }}'.split(','),
                                    certificates: '{{ resume.resume_certificates|escapejs }}'.split(','),
                                    job_applied: '{{ resume.resume_job_id.job_position|escapejs }}',
                                    status: '{{ resume.resume_status|escapejs }}',
                                    date_added: '{{ resume.resume_date_added|date:'M. d, Y, g a' }}',
                                    cv_path: '{{ resume.resume_path|escapejs }}'
                                })">
                            </i>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">No candidates found.</td>
                    </tr>
                    {% endfor %}                    
                    </tbody>
                </table>

              <!-- Phân trang DEMO-->
              <div class="pagination-container">
                  <div class="row-control">
                      <label for="rowSelect">Rows per page:</label>
                      <select id="rowSelect" onchange="updateRowsPerPage()">
                          <option value="5">5</option>
                          <option value="10">10</option>
                      </select>
                  </div> 
              
                  <div class="pagination">
                      <button id="prevPage" onclick="changePage(-1)" disabled>
                          <i class="fas fa-chevron-left"></i>
                      </button>
                      <span>1-1 of 1</span>
                      <button id="nextPage" onclick="changePage(1)">
                          <i class="fas fa-chevron-right"></i>
                      </button>
                  </div>
              </div>
          </div>
      </div>
    </div>

    <!-- Overlay Info Modal -->
    <div id="overlay" class="overlay" onclick="closeInfo()"></div>

    <!-- Modal show resume info -->
    <div id="infoModal" class="info-modal">
        <div class="modal-content">
            <h5 id="infoTitle"></h5>
            <hr>
            <p><strong>👤 Name:</strong> <span id="infoName"></span></p>
            <p><strong>✉️ Email:</strong> <span id="infoEmail"></span></p>
            <p><strong>📞 Phone Number:</strong> <span id="infoPhone"></span></p>
            <hr>
            <p><strong>🎓 Education:</strong> <span id="infoEducation"></span></p>
            <p><strong>💼 Experience:</strong> <span id="infoExperience"></span></p>
            <p><strong>⚙️ Technical Skills:</strong> <span id="infoSkills"></span></p>
            <p><strong>💡 Soft Skills:</strong> <span id="infoSoftSkills"></span></p>
            <p><strong>📜 Certificates:</strong> <span id="infoCertificates"></span></p>
            <p><strong>📝 Job Applied:</strong> <span id="infoJobApplied"></span></p>
            <hr>
            <p><strong>📈 Results:</strong> <span id="infoResults"></span></p>
            <p><strong>📅 CV Added Date:</strong> <span id="infoAddedDate"></span></p>
            <p><strong>📄 File Path:</strong> <span id="infoPath"></span></p>
            <button class="btn btn-secondary" onclick="closeInfo()">Close</button>
        </div>
    </div>
    

    <!-- Delete Resume Confirmation Modal -->
    <div class="modal fade" id="deleteResumeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this candidate CV?</p>
                    <input type="hidden" id="deleteResumeId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteResume">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal edit resume info -->
    <div class="modal fade" id="editResumeModal" tabindex="-1" aria-labelledby="editResumeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editResumeModalLabel">Edit Resume</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editResumeForm">
                        {% csrf_token %}
                        <input type="hidden" name="job_id" id="editResumeId">

                        <div class="mb-3">
                            <label class="form-label">Position Name</label>
                            <input type="text" class="form-control" id="editJobPosition" name="job_position">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Job Description</label>
                            <textarea class="form-control" id="editJobDescription" name="job_description"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Education</label>
                            <input type="text" class="form-control" id="editJobEducation" name="job_education">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Experience Level</label>
                            <select class="form-control" id="editJobExperience" name="job_experience">
                                <option value="NR">Not requirement</option>
                                <option value="LT1">Less than 1 year</option>
                                <option value="1Y">1 year</option>
                                <option value="2Y">2 years</option>
                                <option value="3Y">3 years</option>
                                <option value="4Y">4 years</option>
                                <option value="5Y">5 years</option>
                                <option value="GT5">Greater than 5 years</option>
                            </select>                            
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Responsibilities</label>
                            <textarea class="form-control" id="editJobResponsibilities" name="job_responsibilities"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Technical Skills</label>
                            <input type="text" class="form-control" id="editJobTechSkills" name="job_tech_skills">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Soft Skills</label>
                            <input type="text" class="form-control" id="editJobSoftSkills" name="job_soft_skills">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Certificates</label>
                            <input type="text" class="form-control" id="editJobCertificates" name="job_certificates">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-control" id="editJobStatus" name="job_status">
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="editJobStart" name="job_start">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="editJobEnd" name="job_end">
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Demo (giống job.html) -->
    <script>
        let tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        let tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // For ripple effect
        function rippleEffect(e) {
            let rect = e.target.getBoundingClientRect();
            let x = e.clientX - rect.left; 
            let y = e.clientY - rect.top;
            e.target.style.setProperty("--x", x + "px");
            e.target.style.setProperty("--y", y + "px");
        }

        // Info
        function showInfo(resume) {
            let modal = document.getElementById('infoModal');
            let overlay = document.getElementById('overlay');
        
            // Điền thông tin vào modal
            document.getElementById('infoTitle').innerText =  "Candidate Info";
            document.getElementById('infoName').innerText = resume.name || '';
            document.getElementById('infoEmail').innerText = resume.email || '';
            document.getElementById('infoPhone').innerText = resume.phone || '';
            document.getElementById('infoEducation').innerText = resume.education || '';
            document.getElementById('infoExperience').innerText = resume.experience || '';
            document.getElementById('infoSkills').innerText = resume.skills ? resume.skills.join(', ') : '';
            document.getElementById('infoSoftSkills').innerText = resume.softSkills ? resume.softSkills.join(', ') : '';
            document.getElementById('infoCertificates').innerText = resume.certificates || '';
            document.getElementById('infoResults').innerText = resume.status || '';
            document.getElementById('infoAddedDate').innerText = resume.date_added || '';
            document.getElementById('infoJobApplied').innerText = resume.job_applied|| '';
            document.getElementById('infoPath').innerText = resume.cv_path || '';
        
            // Hiển thị overlay và modal với animation
            overlay.style.display = "block";
            setTimeout(() => overlay.classList.add("show"), 10);
        
            modal.style.display = "block";
            setTimeout(() => modal.classList.add("show"), 10);
        }
    
        function closeInfo() {
            let modal = document.getElementById('infoModal');
            let overlay = document.getElementById('overlay');
        
            // Ẩn overlay và modal với hiệu ứng mượt
            overlay.classList.add("hide");
            modal.classList.add("hide");
        
            setTimeout(() => {
                overlay.classList.remove("show", "hide");
                overlay.style.display = "none";
            
                modal.classList.remove("show", "hide");
                modal.style.display = "none";
            }, 300); // Khớp với thời gian transition trong CSS
        }

        // Giống job.html
        function updateRowsPerPage() {
            alert('Change rows logic');
        }
        function changePage(direction) {
            alert('Change page logic: ' + direction);
        }
    </script>

    <script>
        window.confirmDelete = function(ResumeId) {
            document.getElementById("deleteResumeId").value = ResumeId;
            let modal = new bootstrap.Modal(document.getElementById("deleteResumeModal"));
            modal.show();
        };

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("confirmDeleteResume").addEventListener("click", function () {
                let ResumeId = document.getElementById("deleteResumeId").value;
                fetch("{% url 'candidates' %}", {
                    method: "POST",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                    body: new URLSearchParams({ "action": "delete", "resume_id": ResumeId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let modal = bootstrap.Modal.getInstance(document.getElementById("deleteResumeModal"));
                        modal.hide();
                        location.reload();
                    } else {
                        alert("Error deleting resume.");
                    }
                })
                .catch(error => console.error("Error:", error));
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".edit-btn").forEach(function (button) {
                button.addEventListener("click", function () {
                    let row = this.closest("tr"); // Tìm dòng cha chứa dữ liệu
                
                    // Lấy dữ liệu từ `data-*`
                    document.getElementById("editJobId").value = row.dataset.jobId;
                    document.getElementById("editJobPosition").value = row.dataset.title;
                    document.getElementById("editJobDescription").value = row.dataset.description;
                    document.getElementById("editJobEducation").value = row.dataset.education;
                    document.getElementById("editJobExperience").value = row.dataset.experience;
                    document.getElementById("editJobResponsibilities").value = row.dataset.responsibilities;
                    document.getElementById("editJobTechSkills").value = row.dataset.techSkills;
                    document.getElementById("editJobSoftSkills").value = row.dataset.softSkills;
                    document.getElementById("editJobCertificates").value = row.dataset.certificates;
                    document.getElementById("editJobStatus").value = row.dataset.status;
                    document.getElementById("editJobStart").value = row.dataset.start
                    ? row.dataset.start.replace(" ", "T").substring(0, 16)
                    : "";

                document.getElementById("editJobEnd").value = row.dataset.end
                    ? row.dataset.end.replace(" ", "T").substring(0, 16)
                    : "";

                
                    // Hiển thị modal Edit
                    let modal = new bootstrap.Modal(document.getElementById("editJobModal"));
                    modal.show();
                });
            });
        });

        document.getElementById("editJobForm").addEventListener("submit", function(event) {
            event.preventDefault(); // Prevent page reload

            let formData = new FormData(this);
            formData.append("action", "edit"); // Ensure the action is sent

            fetch("{% url 'job' %}", {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let row = document.querySelector(`tr[data-job-id='${data.job_id}']`);
                
                    if (row) {
                        row.dataset.title = formData.get("job_position");
                        row.dataset.description = formData.get("job_description");
                        row.dataset.education = formData.get("job_education");
                        row.dataset.experience = formData.get("job_experience");
                        row.dataset.responsibilities = formData.get("job_responsibilities");
                        row.dataset.techSkills = formData.get("job_tech_skills");
                        row.dataset.softSkills = formData.get("job_soft_skills");
                        row.dataset.certificates = formData.get("job_certificates");
                        row.dataset.status = formData.get("job_status");
                        row.dataset.start = formData.get("job_start");
                        row.dataset.end = formData.get("job_end");
                    
                        // Update UI instantly
                        row.querySelector(".job-position").innerText = formData.get("job_position");
                        row.querySelector(".job-description").innerText = formData.get("job_description");
                        row.querySelector(".pill").innerText = formData.get("job_status");
                        row.querySelector(".job-start").innerText = formData.get("job_start");
                    }
                
                    // Hide modal after saving
                    let modal = bootstrap.Modal.getInstance(document.getElementById("editJobModal"));
                    modal.hide();
                } else {
                    alert("Error updating job.");
                }
            })
            .catch(error => console.error("Error:", error));
        });
    </script>
{% endblock content %}
